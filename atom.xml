<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Yan&#39;s Blog</title>
  
  
  <link href="https://ovyvo.github.io/yanblog.github.io/atom.xml" rel="self"/>
  
  <link href="https://ovyvo.github.io/yanblog.github.io/"/>
  <updated>2022-11-27T04:13:15.827Z</updated>
  <id>https://ovyvo.github.io/yanblog.github.io/</id>
  
  <author>
    <name>OVYVO</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>commitlint+husky+commitizen+lint-stage代码风格及上传规范管理</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2022/11/08/blog9/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2022/11/08/blog9/</id>
    <published>2022-11-07T16:00:00.000Z</published>
    <updated>2022-11-27T04:13:15.827Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>紧接上文说到vite+vue3代码风格及格式化操作，前文主要针对本地化配置格式化。为了更加规范仓库代码，本文引入介绍commitlint等工具，在代码commit的时候再次校验为代码规范再上一层保障。</p></blockquote><h3 id="安装commitlint及commitlint配置包"><a href="#安装commitlint及commitlint配置包" class="headerlink" title="安装commitlint及commitlint配置包"></a>安装commitlint及commitlint配置包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @commitlint/cli  @commitlint/config-conventional -D</span><br></pre></td></tr></table></figure><blockquote><p>添加@commitlint/config-conventional包的目的是使用基础配置，另外也可根据实际需要添加配置文件。例如：commitlint.config.js、.commitlintrc.js、.commitlintrc、.commitlintrc.json、.commitlintrc.yml或package.json中的commit配置</p></blockquote><h3 id="安装husky"><a href="#安装husky" class="headerlink" title="安装husky"></a>安装husky</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用下述命令会在根目录下自动生成.husky文件夹，并创建一个pre-commit钩子实例</span></span><br><span class="line">npx husky-init &amp;&amp; npm install       # npm</span><br><span class="line">npx husky-init &amp;&amp; yarn              # Yarn 1</span><br><span class="line">yarn dlx husky-init --yarn2 &amp;&amp; yarn # Yarn 2+</span><br><span class="line">pnpm dlx husky-init &amp;&amp; pnpm install # pnpm</span><br></pre></td></tr></table></figure><p>还可以使用如下方式安装husky：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install husky --save-dev #安装依赖</span><br><span class="line">npx --no-install husky install #创建.husky目录(使用--no-install的目的是让npx强制使用node_modules目录下的husky依赖包)</span><br><span class="line">npm pkg set scripts.prepare=&quot;husky install&quot; #在package.json中添加初始化命令(此步骤可以省略，但是如果是多人开发会很有必要，初始化仓库可以执行该命令)</span><br><span class="line">npx --no-instal husky add .husky/pre-commit &quot;npm run lint&quot; #快速创建pre-commit钩子</span><br></pre></td></tr></table></figure><p>添加commit-msg hook（该hook会在commitlint未通过时提示相关信息）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx husky add .husky/commit-msg  &#x27;npx --no -- commitlint --edit $&#123;1&#125;&#x27;</span><br></pre></td></tr></table></figure><p>如何判断上述步骤是否成功可以使用简单的test命令测试</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx commitlint --from HEAD~1 --to HEAD --verbose</span><br></pre></td></tr></table></figure><p>执行commit之后如果出现类似的信息即可认为配置成功</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git commit -m &quot;foo: this will fail&quot;</span><br><span class="line">husky &gt; commit-msg (node v10.1.0)</span><br><span class="line">No staged files match any of provided globs.</span><br><span class="line">⧗   input: foo: this will fail</span><br><span class="line">✖   type must be one of [build, chore, ci, docs, feat, fix, perf, refactor, revert, style, test] [type-enum]</span><br><span class="line"></span><br><span class="line">✖   found 1 problems, 0 warnings</span><br><span class="line">ⓘ   Get help: https://github.com/conventional-changelog/commitlint/#what-is-commitlint</span><br><span class="line"></span><br><span class="line">husky &gt; commit-msg hook failed (add --no-verify to bypass)</span><br></pre></td></tr></table></figure><h3 id="添加commitizen"><a href="#添加commitizen" class="headerlink" title="添加commitizen"></a>添加commitizen</h3><p>commitizen工具可以通过交互式撰写符合Commit Message规范的Commit Message</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install commitizen -D</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">or</span></span><br><span class="line">yarn add commitizen -D</span><br></pre></td></tr></table></figure><p>执行如下命令生成符合Angular的Commit message格式提交规范（使用其他规范可以跳过此步骤）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx --no-install commitizen init cz-conventional-changelog --save-dev --save-exact</span><br></pre></td></tr></table></figure><p>!!!若使用上述命令，需要在package.json中配置一下commitizen适配器</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">&quot;config&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;commitizen&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;path&quot;</span>: <span class="string">&quot;./node_modules/cz-conventional-changelog&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外在package.json中的scripts中添加commit脚本替代git commit</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;cz&quot;</span>: <span class="string">&quot;git add . &amp;&amp; git-cz&quot;</span>,</span><br><span class="line">    <span class="string">&quot;prepare&quot;</span>: <span class="string">&quot;husky install&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>执行完上述操作就可以使用脚本提交代码</p><h3 id="配置commitlint"><a href="#配置commitlint" class="headerlink" title="配置commitlint"></a>配置commitlint</h3><p>在根目录下新建文件.commitlintrc.js：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 具体配置可参考https://commitlint.js.org/#/reference-rules自行配置不做详细说明</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">ignores</span>: [<span class="function">(<span class="params">commit</span>) =&gt;</span> commit.<span class="title function_">includes</span>(<span class="string">&#x27;init&#x27;</span>)],</span><br><span class="line">  <span class="attr">extends</span>: [<span class="string">&#x27;@commitlint/config-conventional&#x27;</span>],</span><br><span class="line">  <span class="attr">rules</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;header-max-length&#x27;</span>: [<span class="number">2</span>, <span class="string">&#x27;always&#x27;</span>, <span class="number">72</span>],</span><br><span class="line">    <span class="string">&#x27;scope-case&#x27;</span>: [<span class="number">2</span>, <span class="string">&#x27;always&#x27;</span>, <span class="string">&#x27;lowerCase&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;subject-empty&#x27;</span>: [<span class="number">2</span>, <span class="string">&#x27;never&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;subject-case&#x27;</span>: [<span class="number">2</span>, <span class="string">&#x27;always&#x27;</span>, [<span class="string">&#x27;lower-case&#x27;</span>, <span class="string">&#x27;sentence-case&#x27;</span>, <span class="string">&#x27;start-case&#x27;</span>, <span class="string">&#x27;pascal-case&#x27;</span>, <span class="string">&#x27;upper-case&#x27;</span>]],</span><br><span class="line">    <span class="string">&#x27;subject-full-stop&#x27;</span>: [<span class="number">2</span>, <span class="string">&#x27;never&#x27;</span>, <span class="string">&#x27;.&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;type-empty&#x27;</span>: [<span class="number">2</span>, <span class="string">&#x27;never&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;type-case&#x27;</span>: [<span class="number">2</span>, <span class="string">&#x27;always&#x27;</span>, <span class="string">&#x27;lowerCase&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;type-enum&#x27;</span>: [<span class="number">2</span>, <span class="string">&#x27;always&#x27;</span>, [<span class="string">&#x27;feat&#x27;</span>, <span class="string">&#x27;fix&#x27;</span>, <span class="string">&#x27;docs&#x27;</span>, <span class="string">&#x27;style&#x27;</span>, <span class="string">&#x27;perf&#x27;</span>, <span class="string">&#x27;chore&#x27;</span>, <span class="string">&#x27;build&#x27;</span>]]</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="commitizen输出汉化"><a href="#commitizen输出汉化" class="headerlink" title="commitizen输出汉化"></a>commitizen输出汉化</h3><p>安装commitlint-config-cz插件配置commit message</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm install commitlint-config-cz -D #cz配置插件</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">or</span></span><br><span class="line">yarn add commitlint-config-cz -D #cz配置插件</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">and</span></span><br><span class="line">npm install cz-customizable -D #cz适配器插件</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">or</span></span><br><span class="line">yarn add cz-customizable -D #cz适配器插件</span><br></pre></td></tr></table></figure><p>在项目根目录下新建.cz-config.js文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置文件可参考https://github.com/leoforfree/cz-customizable/blob/HEAD/cz-config-EXAMPLE.js自行配置不做详细说明</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">types</span>: [</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="string">&#x27;:sparkles: feat&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;✨ feat: 一项新功能&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="string">&#x27;:bug: fix&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;🐛 fix: 修复一个Bug&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="string">&#x27;:memo: docs&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;📝 docs: 文档变更&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="string">&#x27;:lipstick: style&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;💄 style: 代码风格，格式修复&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="string">&#x27;:zap: perf&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;⚡️ perf: 代码优化,改善性能&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="string">&#x27;:rocket: chore&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;🚀 chore: 变更构建流程或辅助工具&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="string">&#x27;:package: build&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;📦️ build: 变更项目构建或外部依赖&#x27;</span> &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">messages</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;请选择提交类型(必填):&#x27;</span>,</span><br><span class="line">    <span class="attr">subject</span>: <span class="string">&#x27;请简要描述提交(必填):&#x27;</span>,</span><br><span class="line">    <span class="attr">confirmCommit</span>: <span class="string">&#x27;确定提交此说明吗？&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">skipQuestions</span>: [<span class="string">&#x27;scope&#x27;</span>, <span class="string">&#x27;body&#x27;</span>, <span class="string">&#x27;breaking&#x27;</span>, <span class="string">&#x27;footer&#x27;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建完.cz-config.js </p><ul><li>返回package.json修改commitizen适配器选项<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="string">&quot;config&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;commitizen&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;node_modules/cz-customizable&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li><li>若之前使用Angular的Commit message格式提交规范，需修改.commitlintrc.js文件，节约空间可以卸载掉@commitlint/config-conventional插件（用不上了）<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">extends</span>: [],</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="集成-gitmoji"><a href="#集成-gitmoji" class="headerlink" title="集成 gitmoji"></a>集成 gitmoji</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install commitlint-config-gitmoji -D</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">or</span></span><br><span class="line">yarn add commitlint-config-gitmoji -D</span><br></pre></td></tr></table></figure>修改.commitlintrc.js<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">extends</span>: [<span class="string">&#x27;gitmoji&#x27;</span>],</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>使用gitmoji的时候可能会遇到如下问题：</li></ul><ol><li>报错找不到gitmojis.json 两种解决方案：<pre><code>在node_modules/commitlint-plugin-gitmoji/lib下添加gitmojis.json</code></pre> 在根目录下添加gitmojis.json并修改.cz-config.js <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">process.<span class="property">env</span>.<span class="property">GITMOJI_PATH</span> = <span class="string">&#x27;.gitmoji.json&#x27;</span></span><br><span class="line">modules.<span class="property">exports</span>=&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string">2. 偶遇校验不通过需要严格按照上述事例配置.commitlintrc.js（列出来的rule勿改）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### 安装lint-stage</span></span><br><span class="line"><span class="string">文件过滤器，每次只校验commit的文件</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>shell</span><br><span class="line">npm install lint-staged -D</span><br><span class="line">#or</span><br><span class="line">yarn add lint-stage -D</span><br></pre></td></tr></table></figure>修改.husky/pre-commit<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#!<span class="regexp">/usr/</span>bin/env sh</span><br><span class="line">. <span class="string">&quot;$(dirname -- &quot;</span>$<span class="number">0</span><span class="string">&quot;)/_/husky.sh&quot;</span></span><br><span class="line"></span><br><span class="line">npx lint-staged</span><br></pre></td></tr></table></figure>修改package.json<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 具体使用可参考lint-stage介绍：https://github.com/okonet/lint-staged#readme</span></span><br><span class="line">...</span><br><span class="line"><span class="string">&quot;lint-staged&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;*.&#123;js,jsx,ts,tsx&#125;&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;eslint --fix&quot;</span>, <span class="comment">//eslint校验</span></span><br><span class="line">    <span class="string">&quot;prettier --write&quot;</span> <span class="comment">//prettier格式化</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;*.vue&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;eslint --fix&quot;</span>,</span><br><span class="line">    <span class="string">&quot;prettier --write&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>有关eslint及prettier的问题可以参见上篇文章。<a href="https://ovyvo.github.io/yanblog.github.io/2022/10/28/blog8/">vite+vue3代码风格校验及格式化</a></li></ol><p>以上就是本文全部内容，由于项目成本关系没有引入其他工具，像文件校验，commit-log自动添加，stylelint等，有兴趣的朋友可以自行尝试。</p><h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><p><a href="https://download.csdn.net/download/V_AYA_V/86725149?spm=1001.2014.3001.5503">gitmojis.json文件地址</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;紧接上文说到vite+vue3代码风格及格式化操作，前文主要针对本地化配置格式化。为了更加规范仓库代码，本文引入介绍commitlint等工具，在代码commit的时候再次校验为代码规范再上一层保障。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 i</summary>
      
    
    
    
    <category term="工具" scheme="https://ovyvo.github.io/yanblog.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="代码规范" scheme="https://ovyvo.github.io/yanblog.github.io/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/"/>
    
  </entry>
  
  <entry>
    <title>prettier+eslint+commitlint项目实践</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2022/10/28/blog8/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2022/10/28/blog8/</id>
    <published>2022-10-28T00:00:00.000Z</published>
    <updated>2022-11-27T04:13:15.827Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>团队代码风格统一一直是博主想干又没有时间去干的事情，刚好借着新项目搭建，尝试一下使用Eslint及Prettier工具提升一下项目代码的整体质量。本文在配置方面仅做简单的配置，流程熟悉可以参考Eslint及Prettier官方文档定制自己喜欢的标准。</p></blockquote><h3 id="安装Eslint包"><a href="#安装Eslint包" class="headerlink" title="安装Eslint包"></a>安装Eslint包</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install eslint <span class="literal">-D</span></span><br></pre></td></tr></table></figure><h3 id="初始化Eslint"><a href="#初始化Eslint" class="headerlink" title="初始化Eslint"></a>初始化Eslint</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init @eslint/config</span><br></pre></td></tr></table></figure><p>执行命令后会出现以下选项：（可以按照图片配置，也可以后面直接更改.eslintrc.cjs文件）<br><img src="https://img-blog.csdnimg.cn/d9d106e8d2724340b5e4c5b7dd63cf9e.png" alt="init详情"><br>具体配置可以以自己项目为准，博主这里使用的是vite+vue3+js<br>安装完成之后项目的根目录会出现.eslintrc.cjs文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="string">&quot;env&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;browser&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;es2021&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;node&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;extends&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;eslint:recommended&quot;</span>,</span><br><span class="line">        <span class="string">&quot;plugin:vue/vue3-essential&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;overrides&quot;</span>: [</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;parserOptions&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ecmaVersion&quot;</span>: <span class="string">&quot;latest&quot;</span>,</span><br><span class="line">        <span class="string">&quot;sourceType&quot;</span>: <span class="string">&quot;module&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;plugins&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;vue&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;rules&quot;</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="安装vite-plugin-eslint包"><a href="#安装vite-plugin-eslint包" class="headerlink" title="安装vite-plugin-eslint包"></a>安装vite-plugin-eslint包</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 该包的作用是在vite运行时自动检测eslint规范，根据配置在终端显示未通过的校验代码</span><br><span class="line">npm install vite<span class="literal">-plugin-eslint</span> <span class="literal">-D</span></span><br></pre></td></tr></table></figure><h3 id="安装eslint-parser-及-babel-core-包"><a href="#安装eslint-parser-及-babel-core-包" class="headerlink" title="安装eslint-parser 及 @babel/core 包"></a>安装eslint-parser 及 @babel/core 包</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 该包的作用是允许eslint在babel转换的源代码上运行</span><br><span class="line">npm install @babel/eslint<span class="literal">-parser</span> <span class="literal">-D</span></span><br><span class="line">npm install @babel/core <span class="literal">-D</span></span><br></pre></td></tr></table></figure><h3 id="安装prettier相关包"><a href="#安装prettier相关包" class="headerlink" title="安装prettier相关包"></a>安装prettier相关包</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install prettier <span class="literal">-D</span></span><br><span class="line">npm install eslint<span class="literal">-config-prettier</span> <span class="literal">-D</span> // eslint兼容的插件,将关闭eslint所有不必要或可能与Prettier冲突的规则</span><br><span class="line">npm install eslint<span class="literal">-plugin-prettier</span> <span class="literal">-D</span> // eslint的prettier,将Prettier作为ESLint规则运行，并将差异作为单个ESLint问题报告。</span><br></pre></td></tr></table></figure><h3 id="安装vue-eslint-parser包"><a href="#安装vue-eslint-parser包" class="headerlink" title="安装vue-eslint-parser包"></a>安装vue-eslint-parser包</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 用于`.vue`文件的ESLint自定义解析器。</span><br><span class="line">npm install vue<span class="literal">-eslint-parser</span> <span class="literal">-D</span></span><br></pre></td></tr></table></figure><h3 id="配置-prettierrc"><a href="#配置-prettierrc" class="headerlink" title="配置.prettierrc"></a>配置.prettierrc</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .prettierrc, 配置不做过多说明，具体可查阅相关文档</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;printWidth&quot;</span>: <span class="number">120</span>,</span><br><span class="line">  <span class="string">&quot;tabWidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="string">&quot;useTabs&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;semi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;trailingComma&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">  <span class="string">&quot;singleQuote&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;bracketSpacing&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;jsxBracketSameLine&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;endOfLine&quot;</span>: <span class="string">&quot;auto&quot;</span>,</span><br><span class="line">  <span class="string">&quot;arrowParens&quot;</span>: <span class="string">&quot;avoid&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="配置-eslintrc-cjs"><a href="#配置-eslintrc-cjs" class="headerlink" title="配置.eslintrc.cjs"></a>配置.eslintrc.cjs</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">env</span>: &#123;</span><br><span class="line">    <span class="attr">browser</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">es2021</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">node</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">extends</span>: [</span><br><span class="line">    <span class="string">&#x27;eslint:recommended&#x27;</span>, <span class="comment">// eslint核心规则</span></span><br><span class="line">    <span class="string">&#x27;plugin:vue/vue3-essential&#x27;</span>, <span class="comment">// 继承eslint-plugin-vue组件中的基础配置</span></span><br><span class="line">    <span class="string">&#x27;plugin:prettier/recommended&#x27;</span>, <span class="comment">// 继承eslint-plugin-prettier组件中的基础配置</span></span><br><span class="line">    <span class="string">&#x27;eslint-config-prettier&#x27;</span> <span class="comment">// 处理配置兼容问题</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">parser</span>: <span class="string">&#x27;vue-eslint-parser&#x27;</span>, <span class="comment">// 使用vue解析器</span></span><br><span class="line">  <span class="attr">parserOptions</span>: &#123; <span class="comment">// 设置支持的JavaScript语言选项</span></span><br><span class="line">    <span class="attr">ecmaVersion</span>: <span class="string">&#x27;latest&#x27;</span>, <span class="comment">// 指定EcmaScript的版本</span></span><br><span class="line">    <span class="attr">sourceType</span>: <span class="string">&#x27;module&#x27;</span>, <span class="comment">// script/module</span></span><br><span class="line">    <span class="attr">ecmaFeatures</span>: &#123;</span><br><span class="line">      <span class="attr">jsx</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>:[</span><br><span class="line">  <span class="string">&#x27;vue&#x27;</span>, <span class="comment">// eslint-plugin-vue缩写</span></span><br><span class="line">  <span class="string">&#x27;prettier&#x27;</span> <span class="comment">// eslint-plugin-prettier缩写</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">globals</span>: &#123;</span><br><span class="line">  <span class="comment">// 添加全局变量，防止no-undef 规则发出警告</span></span><br><span class="line">    <span class="attr">defineProps</span>: <span class="string">&#x27;readonly&#x27;</span>,</span><br><span class="line">    <span class="attr">defineEmits</span>: <span class="string">&#x27;readonly&#x27;</span>,</span><br><span class="line">    <span class="attr">defineExpose</span>: <span class="string">&#x27;readonly&#x27;</span>,</span><br><span class="line">    <span class="attr">withDefaults</span>: <span class="string">&#x27;readonly&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">rules</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;no-console&#x27;</span>: <span class="string">&#x27;warn&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vue/multi-word-component-names&#x27;</span>: <span class="string">&#x27;off&#x27;</span> <span class="comment">// extends中继承过来的属性，可以重新修改</span></span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="VSCode配置"><a href="#VSCode配置" class="headerlink" title="VSCode配置"></a>VSCode配置</h3><p>安装ESLint及Prettier插件<br><img src="https://img-blog.csdnimg.cn/4690e67f62214702b6661568c0861a34.png" alt="Eslint插件"><br><img src="https://img-blog.csdnimg.cn/bce24e7cf92543f6b7a9552221ccb58c.png" alt="Prettier插件"></p><ol><li>打开VSCode设置&gt;用户&gt;文本编辑器&gt;格式化&gt;勾选Format On Save</li></ol><p><img src="https://img-blog.csdnimg.cn/6b72652fe60d4251b7b213b4ab0b4175.png" alt="配置保存自动格式化"><br>2. 搜索Prettier&gt;勾选Require Config<br><img src="https://img-blog.csdnimg.cn/fb501a9997c947f2b4a2b5be516add31.png" alt="配置方案文件"><br>3.打开VSCode设置&gt;用户&gt;文本编辑器&gt;Default Formatter&gt;选择Prettier - Code formatter<br><img src="https://img-blog.csdnimg.cn/4a56242e17a443fdad906b636403427a.png" alt="配置默认格式化程序"><br>4.ctr+shift+p打开首选项配置settings.json&gt;添加eslint vue支持</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="string">&quot;eslint.validate&quot;</span>: [</span><br><span class="line">  <span class="string">&quot;javascript&quot;</span>,</span><br><span class="line">   <span class="string">&quot;javascriptreact&quot;</span>,</span><br><span class="line">   <span class="string">&quot;vue&quot;</span></span><br><span class="line"> ],</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>特别提醒：每次修改完Eslint及Prettier配置最好重新启动VSCode，防止出现配置不生效的情况</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;团队代码风格统一一直是博主想干又没有时间去干的事情，刚好借着新项目搭建，尝试一下使用Eslint及Prettier工具提升一下项目代码的整体质量。本文在配置方面仅做简单的配置，流程熟悉可以参考Eslint及Prettier官方文档定制自己喜欢的标准</summary>
      
    
    
    
    <category term="工具" scheme="https://ovyvo.github.io/yanblog.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="代码规范" scheme="https://ovyvo.github.io/yanblog.github.io/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/"/>
    
  </entry>
  
  <entry>
    <title>Element组件MessageBox剖析</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2022/10/10/blog7/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2022/10/10/blog7/</id>
    <published>2022-10-10T00:00:00.000Z</published>
    <updated>2022-10-10T11:00:56.172Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>因最近业务需求需要实现类似于Element中的MessageBox组件的效果，所以尝试封装了一个类似的小组件，本文不介绍封装，因为受到MessageBox的启发，所以通过源码注释的方式详细剖析一下Element的MessageBox实现思想。</p></blockquote><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><p>Vue.extend(options)</p><ul><li>参数：{Object} options</li><li>用法：使用基础 Vue 构造器，创建一个“子类”。参数是一个包含组件选项的对象。需要注意的是：data 选项是特例，需要注意 - 在 Vue.extend() 中它必须是函数</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;mount-point&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建构造器</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Profile</span> = <span class="title class_">Vue</span>.<span class="title function_">extend</span>(&#123;</span><br><span class="line">  <span class="attr">template</span>: <span class="string">&#x27;&lt;p&gt;&#123;&#123;firstName&#125;&#125; &#123;&#123;lastName&#125;&#125; aka &#123;&#123;alias&#125;&#125;&lt;/p&gt;&#x27;</span>,</span><br><span class="line">  <span class="attr">data</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">firstName</span>: <span class="string">&#x27;Walter&#x27;</span>,</span><br><span class="line">      <span class="attr">lastName</span>: <span class="string">&#x27;White&#x27;</span>,</span><br><span class="line">      <span class="attr">alias</span>: <span class="string">&#x27;Heisenberg&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 创建 Profile 实例，并挂载到一个元素上。</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Profile</span>().$mount(<span class="string">&#x27;#mount-point&#x27;</span>)</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Walter White aka Heisenberg<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>为什么要介绍Vue.extend(options)，因为Element中MessageBox的使用方式为函数式调用 （this.$confirm()）的形式，以这种形式调用组件就不能按照常规的组件引入注册的形式去调用，可以通过Vue.extend(options)创建一个vue子类再通过函数暴露出去的方式实现函数式调用。</p></blockquote><h3 id="Element-MessageBox-源码"><a href="#Element-MessageBox-源码" class="headerlink" title="Element MessageBox 源码"></a>Element MessageBox 源码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js 仅介绍主要部分代码</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="comment">// 引入模板文件</span></span><br><span class="line"><span class="keyword">import</span> msgboxVue <span class="keyword">from</span> <span class="string">&#x27;./main.vue&#x27;</span>; </span><br><span class="line"><span class="comment">// element合并对象的工具函数，代码比较简单可以自行查阅</span></span><br><span class="line"><span class="keyword">import</span> merge <span class="keyword">from</span> <span class="string">&#x27;element-ui/src/utils/merge&#x27;</span>; </span><br><span class="line"><span class="keyword">import</span> &#123; isVNode &#125; <span class="keyword">from</span> <span class="string">&#x27;element-ui/src/utils/vdom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个新的vue构造器，构造器可以手动挂载到一个新的Dom上</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MessageBoxConstructor</span> = <span class="title class_">Vue</span>.<span class="title function_">extend</span>(msgboxVue);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> currentMsg, instance;</span><br><span class="line"><span class="keyword">let</span> msgQueue = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个新的vue子实例</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">initInstance</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  instance = <span class="keyword">new</span> <span class="title class_">MessageBoxConstructor</span>(&#123;</span><br><span class="line">    <span class="attr">el</span>: <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 给实例添加callback对象，后面会分析到</span></span><br><span class="line">  instance.<span class="property">callback</span> = defaultCallback;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// defaultCallback处理了两种形式的回调方式</span></span><br><span class="line"><span class="comment">// 1.可以手动传入一个callback函数</span></span><br><span class="line"><span class="comment">// 2.使用默认的promise方式</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">defaultCallback</span> = action =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (currentMsg) &#123;</span><br><span class="line">    <span class="keyword">let</span> callback = currentMsg.<span class="property">callback</span>;</span><br><span class="line">    <span class="comment">// 处理传入回调函数情况</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// showInput区分是否为输入框MessageBox</span></span><br><span class="line">      <span class="keyword">if</span> (instance.<span class="property">showInput</span>) &#123;</span><br><span class="line">        <span class="title function_">callback</span>(instance.<span class="property">inputValue</span>, action);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">callback</span>(action, instance);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理promise情况</span></span><br><span class="line">    <span class="keyword">if</span> (currentMsg.<span class="property">resolve</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (action === <span class="string">&#x27;confirm&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance.<span class="property">showInput</span>) &#123;</span><br><span class="line">          currentMsg.<span class="title function_">resolve</span>(&#123; <span class="attr">value</span>: instance.<span class="property">inputValue</span>, action &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          currentMsg.<span class="title function_">resolve</span>(action);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentMsg.<span class="property">reject</span> &amp;&amp; (action === <span class="string">&#x27;cancel&#x27;</span> || action === <span class="string">&#x27;close&#x27;</span>)) &#123;</span><br><span class="line">        currentMsg.<span class="title function_">reject</span>(action);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">showNextMsg</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!instance) &#123;</span><br><span class="line">    <span class="title function_">initInstance</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  instance.<span class="property">action</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!instance.<span class="property">visible</span> || instance.<span class="property">closeTimer</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (msgQueue.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 顺序执行msgQueue中的currentMsg</span></span><br><span class="line">      currentMsg = msgQueue.<span class="title function_">shift</span>();</span><br><span class="line">      <span class="comment">// currentMsg内容如下:</span></span><br><span class="line">      <span class="comment">// &#123;</span></span><br><span class="line">      <span class="comment">//   options: merge(&#123;&#125;, defaults, MessageBox.defaults, options),</span></span><br><span class="line">      <span class="comment">//   callback: callback,</span></span><br><span class="line">      <span class="comment">//   resolve: resolve,</span></span><br><span class="line">      <span class="comment">//   reject: reject</span></span><br><span class="line">      <span class="comment">// &#125;</span></span><br><span class="line">      <span class="keyword">let</span> options = currentMsg.<span class="property">options</span>;</span><br><span class="line">      <span class="comment">// 将参数挂载到新创建的实例data上</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> prop <span class="keyword">in</span> options) &#123;</span><br><span class="line">        <span class="keyword">if</span> (options.<span class="title function_">hasOwnProperty</span>(prop)) &#123;</span><br><span class="line">          <span class="comment">// 实例参数修改</span></span><br><span class="line">          instance[prop] = options[prop];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 如果options没传入callback将默认的callback赋值给实例的callback</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">callback</span> === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="comment">// 当options里面有callback传入，正常输出。</span></span><br><span class="line">        <span class="comment">// 当options里面没有callback,instance.callback使用defaultCallback</span></span><br><span class="line">        instance.<span class="property">callback</span> = defaultCallback;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 再次封装callback</span></span><br><span class="line">      <span class="keyword">let</span> oldCb = instance.<span class="property">callback</span>;</span><br><span class="line">      instance.<span class="property">callback</span> = <span class="function">(<span class="params">action, instance</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">oldCb</span>(action, instance);</span><br><span class="line">        <span class="title function_">showNextMsg</span>();</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 判断message是否传入的是Html片段,如果是Html片段添加到slot</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isVNode</span>(instance.<span class="property">message</span>)) &#123;</span><br><span class="line">        instance.<span class="property">$slots</span>.<span class="property">default</span> = [instance.<span class="property">message</span>];</span><br><span class="line">        instance.<span class="property">message</span> = <span class="literal">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">delete</span> instance.<span class="property">$slots</span>.<span class="property">default</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 将某些特定的参数设定初始值</span></span><br><span class="line">      [<span class="string">&#x27;modal&#x27;</span>, <span class="string">&#x27;showClose&#x27;</span>, <span class="string">&#x27;closeOnClickModal&#x27;</span>, <span class="string">&#x27;closeOnPressEscape&#x27;</span>, <span class="string">&#x27;closeOnHashChange&#x27;</span>].<span class="title function_">forEach</span>(<span class="function"><span class="params">prop</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance[prop] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">          instance[prop] = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// 注意message是挂载到body上</span></span><br><span class="line">      <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(instance.<span class="property">$el</span>);</span><br><span class="line">      <span class="comment">// 控制弹窗出现</span></span><br><span class="line">      <span class="title class_">Vue</span>.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        instance.<span class="property">visible</span> = <span class="literal">true</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MessageBox</span> = <span class="keyword">function</span>(<span class="params">options, callback</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$isServer</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">&#x27;string&#x27;</span> || <span class="title function_">isVNode</span>(options)) &#123;</span><br><span class="line">    <span class="comment">// 当options参数为字符串 this.$msgbox(&#x27;xxx&#x27;)情况下默认设置message字段</span></span><br><span class="line">    options = &#123;</span><br><span class="line">      <span class="attr">message</span>: options</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 若有两个及以上参数判断第二个参数是否为字符串赋值给title</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">arguments</span>[<span class="number">1</span>] === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      options.<span class="property">title</span> = <span class="variable language_">arguments</span>[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">callback</span> &amp;&amp; !callback) &#123;</span><br><span class="line">    <span class="comment">// 参数为对象且对象有callback字段时 将callback赋值给callback</span></span><br><span class="line">    callback = options.<span class="property">callback</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 兼容不支持Promise情况</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123; <span class="comment">// eslint-disable-line</span></span><br><span class="line">      msgQueue.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">options</span>: <span class="title function_">merge</span>(&#123;&#125;, defaults, <span class="title class_">MessageBox</span>.<span class="property">defaults</span>, options),</span><br><span class="line">        <span class="attr">callback</span>: callback,</span><br><span class="line">        <span class="attr">resolve</span>: resolve,</span><br><span class="line">        <span class="attr">reject</span>: reject</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="title function_">showNextMsg</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    msgQueue.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">options</span>: <span class="title function_">merge</span>(&#123;&#125;, defaults, <span class="title class_">MessageBox</span>.<span class="property">defaults</span>, options),</span><br><span class="line">      <span class="attr">callback</span>: callback</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">showNextMsg</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用方式1:</span></span><br><span class="line">  <span class="comment">// this.$msgbox(&#123;title:&#x27;测试&#x27;,message:&#x27;测试&#x27;,callback:(action,instance)=&gt;&#123;</span></span><br><span class="line">  <span class="comment">//   console.log(action) //confirm</span></span><br><span class="line">  <span class="comment">//   console.log(instance) //vue实例</span></span><br><span class="line">  <span class="comment">// &#125;&#125;)</span></span><br><span class="line">  <span class="comment">// 使用方式2:</span></span><br><span class="line">  <span class="comment">// this.$msgbox(&#123;title:&#x27;测试&#x27;,message:&#x27;测试&#x27;&#125;,(action,instance)=&gt;&#123;</span></span><br><span class="line">  <span class="comment">//   console.log(action) //confirm</span></span><br><span class="line">  <span class="comment">//   console.log(instance) //undefined</span></span><br><span class="line">  <span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 暴露MessageBox方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">MessageBox</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; <span class="title class_">MessageBox</span> &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>可以看出Message组件主要的两个方法一个是MessageBox，一个是showNextMsg，这两个方法的主要功能一个是添加新的message对象一个是设置实例参数，除了callback的理解有些复杂外其他的代码理解应该不难。至于main.vue文件就是普通的vue文件不再赘述。</p></blockquote><h3 id="简单实现"><a href="#简单实现" class="headerlink" title="简单实现"></a>简单实现</h3><p><a href="https://ovyvo.github.io/rocket-ui/components/message-box.html">MessageBox组件</a><br><a href="https://github.com/OVYVO/rocket-ui/tree/main/packages/message-box/src">源码</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;因最近业务需求需要实现类似于Element中的MessageBox组件的效果，所以尝试封装了一个类似的小组件，本文不介绍封装，因为受到MessageBox的启发，所以通过源码注释的方式详细剖析一下Element的MessageBox实现思想。&lt;/p</summary>
      
    
    
    
    <category term="组件" scheme="https://ovyvo.github.io/yanblog.github.io/categories/%E7%BB%84%E4%BB%B6/"/>
    
    
    <category term="Element" scheme="https://ovyvo.github.io/yanblog.github.io/tags/Element/"/>
    
  </entry>
  
  <entry>
    <title>Linux常见命令总结</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2022/08/27/blog6/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2022/08/27/blog6/</id>
    <published>2022-08-26T16:00:00.000Z</published>
    <updated>2022-08-27T09:43:39.955Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>总结一下常见Linux操作命令，以备不时之需</p></blockquote><h4 id="目录与文件相关"><a href="#目录与文件相关" class="headerlink" title="目录与文件相关"></a>目录与文件相关</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwd <span class="comment">//显示当前工作目录</span></span><br><span class="line">mkdir <span class="string">&#x27;dir&#x27;</span> <span class="comment">//创建工作目录</span></span><br><span class="line">rmdir <span class="string">&#x27;dir&#x27;</span> <span class="comment">//删除工作目录</span></span><br><span class="line">cd <span class="string">&#x27;dir&#x27;</span> <span class="comment">//进入文件夹</span></span><br><span class="line">cd .. <span class="comment">//返回上层目录</span></span><br><span class="line">touch <span class="string">&#x27;file&#x27;</span> <span class="comment">//创建文件</span></span><br><span class="line">rm -rf <span class="string">&#x27;file/dir&#x27;</span> <span class="comment">//删除文件或目录</span></span><br><span class="line">ls <span class="comment">//列出所有文件和目录</span></span><br><span class="line">ls -a <span class="comment">//查看所有文件(包括隐藏文件)</span></span><br><span class="line">ls -l <span class="comment">//详细显示</span></span><br><span class="line">ls -m <span class="comment">//逗号分隔显示</span></span><br></pre></td></tr></table></figure><h4 id="文件内容显示"><a href="#文件内容显示" class="headerlink" title="文件内容显示"></a>文件内容显示</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; <span class="string">&#x27;file&#x27;</span> <span class="comment">//创建文件并编辑内容（ctr+D结束编辑）</span></span><br><span class="line">cat -n <span class="string">&#x27;file&#x27;</span> <span class="comment">//查看文件</span></span><br></pre></td></tr></table></figure><h4 id="vi编辑器"><a href="#vi编辑器" class="headerlink" title="vi编辑器"></a>vi编辑器</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi [path/file] <span class="comment">//打开编辑器</span></span><br><span class="line">i <span class="comment">//进入编辑模式</span></span><br><span class="line">esc <span class="comment">//进入命令模式</span></span><br><span class="line">:wq <span class="comment">//保存并推出</span></span><br><span class="line">:q! <span class="comment">//退出不保存</span></span><br></pre></td></tr></table></figure><h4 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">clear <span class="comment">//清除屏幕信息</span></span><br><span class="line">date <span class="comment">//显示当前日期</span></span><br><span class="line">ps <span class="comment">//查看所有进程</span></span><br><span class="line">last <span class="comment">//显示最近登陆系统用户信息</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;总结一下常见Linux操作命令，以备不时之需&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;目录与文件相关&quot;&gt;&lt;a href=&quot;#目录与文件相关&quot; class=&quot;headerlink&quot; title=&quot;目录与文件相关&quot;&gt;&lt;/a&gt;目录与文件相关&lt;</summary>
      
    
    
    
    <category term="工具" scheme="https://ovyvo.github.io/yanblog.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="Linux" scheme="https://ovyvo.github.io/yanblog.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>H5在IOS微信webview中无法校验视频时长问题</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2022/07/31/blog5/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2022/07/31/blog5/</id>
    <published>2022-07-30T16:00:00.000Z</published>
    <updated>2022-07-31T11:56:48.542Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>因业务需求需要一个图片视频文件上传功能，需支持主流浏览器及微信钉钉内置浏览器，遂考虑用一个简单的H5页面做上传客户端。视频上传因为要控制视频长度，在其他浏览器中都校验通过，但是在微信中却出了问题</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">beforeRead</span> = (<span class="params">file</span>)=&gt; &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(props.<span class="property">type</span> == <span class="string">&#x27;video&#x27;</span>)&#123;</span><br><span class="line">          <span class="keyword">let</span> url = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(file)</span><br><span class="line">          <span class="keyword">let</span> audioElement = <span class="keyword">new</span> <span class="title class_">Audio</span>(url)</span><br><span class="line">          audioElement.<span class="title function_">addEventListener</span>(<span class="string">&quot;loadedmetadata&quot;</span>, <span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">let</span> audioDuration = audioElement.<span class="property">duration</span>;</span><br><span class="line">            <span class="keyword">if</span>(audioDuration&gt;<span class="number">60</span>)&#123;</span><br><span class="line">              <span class="title class_">Toast</span>(<span class="string">`仅支持上传1分钟时长以内视频`</span>)</span><br><span class="line">              <span class="title function_">reject</span>()</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="title function_">resolve</span>(file)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (![<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>].<span class="title function_">includes</span>(file.<span class="property">type</span>)) &#123;</span><br><span class="line">            <span class="title class_">Toast</span>(<span class="string">&#x27;所选文件格式不支持&#x27;</span>);</span><br><span class="line">            <span class="title function_">reject</span>()</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="title function_">resolve</span>(file)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>问题原因：IOS微信浏览器需要播放视频才能通过监听loadedmetadata事件获取视频长度，以下是解决办法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">beforeRead</span> = (<span class="params">file</span>)=&gt; &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(props.<span class="property">type</span> == <span class="string">&#x27;video&#x27;</span>)&#123;</span><br><span class="line">          <span class="keyword">let</span> url = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(file)</span><br><span class="line">          <span class="keyword">let</span> audioElement = <span class="keyword">new</span> <span class="title class_">Audio</span>(url)</span><br><span class="line">          audioElement.<span class="property">muted</span> = <span class="literal">true</span></span><br><span class="line">          audioElement.<span class="title function_">play</span>().<span class="title function_">then</span>(<span class="function">()=&gt;</span>audioElement.<span class="title function_">pause</span>())</span><br><span class="line">          audioElement.<span class="title function_">addEventListener</span>(<span class="string">&quot;loadedmetadata&quot;</span>, <span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">let</span> audioDuration = audioElement.<span class="property">duration</span>;</span><br><span class="line">            <span class="keyword">if</span>(audioDuration&gt;<span class="number">60</span>)&#123;</span><br><span class="line">              audioElement.<span class="property">muted</span> = <span class="literal">false</span></span><br><span class="line">              <span class="title class_">Toast</span>(<span class="string">`仅支持上传1分钟时长以内视频`</span>)</span><br><span class="line">              <span class="title function_">reject</span>()</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              audioElement.<span class="property">muted</span> = <span class="literal">false</span></span><br><span class="line">              <span class="title function_">resolve</span>(file)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (![<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>].<span class="title function_">includes</span>(file.<span class="property">type</span>)) &#123;</span><br><span class="line">            <span class="title class_">Toast</span>(<span class="string">&#x27;所选文件格式不支持&#x27;</span>);</span><br><span class="line">            <span class="title function_">reject</span>()</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="title function_">resolve</span>(file)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>H5页面vue3.0+vant，参见upload组件不再赘述！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;因业务需求需要一个图片视频文件上传功能，需支持主流浏览器及微信钉钉内置浏览器，遂考虑用一个简单的H5页面做上传客户端。视频上传因为要控制视频长度，在其他浏览器中都校验通过，但是在微信中却出了问题&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure </summary>
      
    
    
    
    <category term="vue" scheme="https://ovyvo.github.io/yanblog.github.io/categories/vue/"/>
    
    
    <category term="vue-3" scheme="https://ovyvo.github.io/yanblog.github.io/tags/vue-3/"/>
    
  </entry>
  
  <entry>
    <title>Taro小程序添加Echarts代码包过大解决办法</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2021/10/19/blog4/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2021/10/19/blog4/</id>
    <published>2021-10-19T00:00:00.000Z</published>
    <updated>2022-10-10T11:00:56.172Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>上回书说到如何在Taro小程序中引入Echarts图表。如果小程序主包代码体量不多可以直接使用，但是如果小程序代码体量大，稍不留神就会导致主包代码超过2M，无法预览也无法真机调试。本文着重介绍一下Taro引入Echarts分包操作以及注意事项。</p></blockquote><h6 id="前文链接，完整流程可以自行查阅-taro小程序添加Echarts实践"><a href="#前文链接，完整流程可以自行查阅-taro小程序添加Echarts实践" class="headerlink" title="前文链接，完整流程可以自行查阅 taro小程序添加Echarts实践"></a>前文链接，完整流程可以自行查阅 <a href="https://blog.csdn.net/V_AYA_V/article/details/120828878">taro小程序添加Echarts实践</a></h6><h6 id="分包操作："><a href="#分包操作：" class="headerlink" title="分包操作："></a>分包操作：</h6><ol><li>将与echarts组件相关都移到分包中，结构目录如下<br><img src="https://img-blog.csdnimg.cn/e54a142d784945938153d51fd8769eed.png" alt="在这里插入图片描述"></li><li>配置app.config.js</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="attr">subpackages</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">root</span>: <span class="string">&quot;subpages&quot;</span>,</span><br><span class="line">      <span class="attr">pages</span>: [</span><br><span class="line">        <span class="string">&#x27;test/index&#x27;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ol start="3"><li>配置config/index<blockquote><p>导致包文件过大的“罪魁祸首”就是ec-canvas文件夹下的echarts.js文件。所以我们需要解决的问题是，分包使用Echarts组件不能将echarts.js打包到主包的common.js里面。Taro机制认为一个js文件被多个模块依赖会将该js抽离到common.js。虽然我们关于Echarts相关的文件都放在subpages里面，但是如果引用多次还是会抽离到主包common.js。所以我们需要使用splitChunks将Echarts部分单独打包，然后使用addChunkPages 往页面注入依赖。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/index.js</span></span><br><span class="line"><span class="attr">mini</span>: &#123;</span><br><span class="line">    <span class="attr">compile</span>: &#123;</span><br><span class="line">      <span class="attr">exclude</span>: [</span><br><span class="line">        <span class="comment">// 跳过编译</span></span><br><span class="line">        path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;src/subpages/components/ec-canvas/echarts.js&#x27;</span>)</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    addChunkPages (pages) &#123;</span><br><span class="line">      pages.<span class="title function_">set</span>(<span class="string">&#x27;subpages/test/index&#x27;</span>, [<span class="string">&#x27;subpages/common&#x27;</span>])</span><br><span class="line">    &#125;,</span><br><span class="line">    webpackChain (chain) &#123;</span><br><span class="line">      chain.<span class="title function_">merge</span>(&#123;</span><br><span class="line">        <span class="attr">optimization</span>: &#123;</span><br><span class="line">          <span class="attr">splitChunks</span>: &#123;</span><br><span class="line">            <span class="attr">cacheGroups</span>: &#123;</span><br><span class="line">              <span class="attr">subpackagesCommon</span>: &#123;</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&#x27;subpages/common&#x27;</span>,</span><br><span class="line">                <span class="attr">minChunks</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="attr">test</span>: <span class="function">(<span class="params"><span class="variable language_">module</span>,chunks</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">const</span> isNoOnlySubpackRequired = chunks.<span class="title function_">find</span>(<span class="function"><span class="params">chunk</span> =&gt;</span> !(<span class="regexp">/\bsubpages\b/</span>.<span class="title function_">test</span>(chunk.<span class="property">name</span>)))</span><br><span class="line">                  <span class="keyword">return</span> !isNoOnlySubpackRequired</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">priority</span>: <span class="number">200</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ol><p>至此可以看到打包效果：<br><img src="https://img-blog.csdnimg.cn/620ab1f3bf9b4e3cb4ec911ba06d41fe.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVl9BWUFfVg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><h6 id="页面引用"><a href="#页面引用" class="headerlink" title="页面引用"></a>页面引用</h6><p>参考前文页面使用。此时如果我们运行代码，可能会发现一个问题：<br><img src="https://img-blog.csdnimg.cn/90ee2801ff3d4c0b84bfa9fa359a0ce4.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVl9BWUFfVg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>注意这个错误！提示找不到ec-canvas组件。<br><img src="https://img-blog.csdnimg.cn/dd60c0daa96c497ebc5d3c0dcfe6e101.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVl9BWUFfVg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>注意编译后的组件ec-canvas.js因为之前抽离了echarts.js，现在已经无法引入，所以需要在编译后的文件中引入subpages里面的common.js。</p><ol><li>添加引入plugin(代码很简单，可以先学习一下官方文档<a href="https://taro-docs.jd.com/taro/docs/plugin#%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E6%8F%92%E4%BB%B6">如何编写一个插件</a>)</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* eslint-disable import/no-commonjs */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  解决chunk包没有引用资源的问题</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">default</span> = <span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">ctx, options</span>) =&gt;</span> &#123;</span><br><span class="line">  ctx.<span class="title function_">onBuildFinish</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> chunkRequireArray = options.<span class="property">chunkRequireArray</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">in</span> chunkRequireArray)&#123;</span><br><span class="line">      <span class="keyword">const</span> unitData = chunkRequireArray[i];</span><br><span class="line">      <span class="keyword">const</span> target = path.<span class="title function_">join</span>(ctx.<span class="property">paths</span>.<span class="property">outputPath</span>, unitData.<span class="property">fileDistPath</span>);</span><br><span class="line">      <span class="keyword">const</span> data = fs.<span class="title function_">readFileSync</span>(target, <span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">      fs.<span class="title function_">writeFileSync</span>(target, <span class="string">`<span class="subst">$&#123;unitData.prependContent&#125;</span>;<span class="subst">$&#123;data&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>配置config/index.js</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">plugins</span>: [</span><br><span class="line">    [</span><br><span class="line">      path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;plugin/chunkCacheRequirePlugin&#x27;</span>),</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">chunkRequireArray</span>:[ <span class="comment">//可配置多个目标引入文件</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">fileDistPath</span>: <span class="string">&#x27;subpages/components/ec-canvas/ec-canvas.js&#x27;</span>,</span><br><span class="line">            <span class="attr">prependContent</span>: <span class="string">&#x27;require(&quot;../../common&quot;);&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  ],</span><br></pre></td></tr></table></figure><p>重新编译就可以了：</p><p><img src="https://img-blog.csdnimg.cn/847970db1d2e464dad26045b1f0f5520.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVl9BWUFfVg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;上回书说到如何在Taro小程序中引入Echarts图表。如果小程序主包代码体量不多可以直接使用，但是如果小程序代码体量大，稍不留神就会导致主包代码超过2M，无法预览也无法真机调试。本文着重介绍一下Taro引入Echarts分包操作以及注意事项。&lt;/</summary>
      
    
    
    
    <category term="taro" scheme="https://ovyvo.github.io/yanblog.github.io/categories/taro/"/>
    
    
    <category term="小程序" scheme="https://ovyvo.github.io/yanblog.github.io/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>Taro小程序引入Echarts教程</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2021/10/18/blog3/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2021/10/18/blog3/</id>
    <published>2021-10-18T00:00:00.000Z</published>
    <updated>2022-07-31T11:43:24.895Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>小程序需要添加简单的数据统计功能。因为对Echats比较熟悉，所以想将Echats引入到项目中，有几点注意事项，记录一下。</p></blockquote><blockquote><p>taro版本：3.3.2（注意一下版本信息）,官方物料仓库里面的Echarts大多不兼容最新版本taro框架，但是实现的思路都是一样的。大致说一下：</p></blockquote><h5 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h5><ol><li><p>下载Echarts官方的小程序插件echarts-for-weixin <a href="https://github.com/ecomfe/echarts-for-weixin">传送门</a><br><img src="https://img-blog.csdnimg.cn/c8b4e2c4f67c43dd88457ada54a57fc5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVl9BWUFfVg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p></li><li><p>将项目中的ec-canvas文件夹复制保存</p></li><li><p>去Echarts官网定制图表(不建议全部下载，文件太大，小程序体积大需要分包) <a href="https://echarts.apache.org/zh/builder.html">传送门</a></p></li><li><p>压缩echarts.js文件(压缩方法可以自行找线上压缩网站或自行压缩，方法附后文）</p></li><li><p>替换ec-canvas文件中的echarts.js文件<br><img src="https://img-blog.csdnimg.cn/375e575d3d6542d0915643b9ac1e9cda.png" alt="在这里插入图片描述"></p><h5 id="本地压缩方法"><a href="#本地压缩方法" class="headerlink" title="本地压缩方法"></a>本地压缩方法</h5></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install uglify-js -g</span><br><span class="line">uglifyjs echarts.<span class="property">js</span> -m -o echarts.<span class="property">min</span>.<span class="property">js</span> <span class="comment">//注意：替换ec-canvas里面的文件时将echarts.min.js换回来</span></span><br></pre></td></tr></table></figure><h5 id="小程序封装图表组件-以柱状图为例"><a href="#小程序封装图表组件-以柱状图为例" class="headerlink" title="小程序封装图表组件(以柱状图为例)"></a>小程序封装图表组件(以柱状图为例)</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 柱状图</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">View</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@tarojs/components&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getCurrentInstance &#125; <span class="keyword">from</span> <span class="string">&quot;@tarojs/taro&quot;</span> <span class="comment">//Taro3.x需要使用getCurrentInstance 获取页面DOM</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./index.scss&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setChartData</span>(<span class="params">chart</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> defautOption = &#123;</span><br><span class="line">    <span class="attr">xAxis</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;category&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: [<span class="string">&quot;Mon&quot;</span>, <span class="string">&quot;Tue&quot;</span>, <span class="string">&quot;Wed&quot;</span>, <span class="string">&quot;Thu&quot;</span>, <span class="string">&quot;Fri&quot;</span>, <span class="string">&quot;Sat&quot;</span>, <span class="string">&quot;Sun&quot;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">yAxis</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;value&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">series</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">data</span>: [<span class="number">120</span>, <span class="number">200</span>, <span class="number">150</span>, <span class="number">80</span>, <span class="number">70</span>, <span class="number">110</span>, <span class="number">130</span>],</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">        <span class="attr">showBackground</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">backgroundStyle</span>: &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="string">&quot;rgba(220, 220, 220, 0.8)&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;;</span><br><span class="line">  chart.<span class="title function_">setOption</span>(defautOption);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">BarChart</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">      <span class="attr">ec</span>: &#123;</span><br><span class="line">        <span class="attr">lazyLoad</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">refresh</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="title function_">getCurrentInstance</span>().<span class="property">page</span>.<span class="title function_">selectComponent</span>(<span class="string">&#x27;#mychart-area&#x27;</span>).<span class="title function_">init</span>(<span class="function">(<span class="params">canvas, width, height</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> chart = echarts.<span class="title function_">init</span>(canvas, <span class="literal">null</span>, &#123;</span><br><span class="line">        <span class="attr">width</span>: width,</span><br><span class="line">        <span class="attr">height</span>: height</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="title function_">setChartData</span>(chart, data);</span><br><span class="line">      <span class="keyword">return</span> chart;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;bar-chart&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ec-canvas</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">id</span>=<span class="string">&#x27;mychart-area&#x27;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">canvasId</span>=<span class="string">&#x27;mychart-area&#x27;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">ec</span>=<span class="string">&#123;this.state.ec&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="页面使用"><a href="#页面使用" class="headerlink" title="页面使用"></a>页面使用</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">View</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@tarojs/components&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">BarChart</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/barChart&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./index.scss&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (props) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">barChart</span> = <span class="title class_">React</span>.<span class="title function_">createRef</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillMount () &#123; &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount () &#123;</span><br><span class="line">    <span class="comment">// 延迟调用，确保 ec-canvas 节点已存在</span></span><br><span class="line">     <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">barChart</span>.<span class="property">current</span>.<span class="title function_">refresh</span>()</span><br><span class="line">     &#125;, <span class="number">100</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillUnmount () &#123; &#125;</span><br><span class="line"></span><br><span class="line">  componentDidShow () &#123; &#125;</span><br><span class="line"></span><br><span class="line">  componentDidHide () &#123; &#125;</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;selfstudy-container&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">BarChart</span> <span class="attr">ref</span>=<span class="string">&#123;this.barChart&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>——————————————————至此图表引入已完成90%————————————————————-<br>直接页面使用的话会报两个错误：</p><ol><li>echarts is not defined。（没有拿到ec-canvas页面实例）<br><img src="https://img-blog.csdnimg.cn/c1a7c829effb4f3c9c1c49e8c6604460.png" alt="在这里插入图片描述"></li></ol><p><strong>解决方法：在 app 或页面配置文件中配置 usingComponents 属性。</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">usingComponents</span>: &#123;</span><br><span class="line">    <span class="comment">// 定义需要引入的第三方组件</span></span><br><span class="line">    <span class="comment">// 1. key 值指定第三方组件名字，以小写开头</span></span><br><span class="line">    <span class="comment">// 2. value 值指定第三方组件 js 文件的相对路径</span></span><br><span class="line">    <span class="string">&#x27;ec-canvas&#x27;</span>: <span class="string">&#x27;../../components/ec-canvas/ec-canvas&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意：Taro3 的组件是没有配置文件的，因此 usingComponents 必须配置在“页面”的配置文件中。<br>2.  t.addEventListener is not a function<br> <img src="https://img-blog.csdnimg.cn/bafdf484508b477ba134037598e2654e.png" alt="在这里插入图片描述"><br><strong>解决方法：在 ec-canvas文件夹下面的wx-canvas.js文件添加代码：</strong></p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">WxCanvas</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">ctx, canvasId, isNew, canvasNode</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span> = ctx;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvasId</span> = canvasId;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chart</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isNew</span> = isNew</span><br><span class="line">    <span class="keyword">if</span> (isNew) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">canvasNode</span> = canvasNode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_initStyle</span>(ctx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this._initCanvas(zrender, ctx);</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_initEvent</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 新增空函数，修复调用 echarts.init 时报错</span></span><br><span class="line">  addEventListener () &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getContext</span>(<span class="params">contextType</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (contextType === <span class="string">&#x27;2d&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;小程序需要添加简单的数据统计功能。因为对Echats比较熟悉，所以想将Echats引入到项目中，有几点注意事项，记录一下。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;taro版本：3.3.2（注意一下版本信息）,官方物料仓</summary>
      
    
    
    
    <category term="taro" scheme="https://ovyvo.github.io/yanblog.github.io/categories/taro/"/>
    
    
    <category term="小程序" scheme="https://ovyvo.github.io/yanblog.github.io/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>Taro小程序分享</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2020/04/03/blog2/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2020/04/03/blog2/</id>
    <published>2020-04-03T00:00:00.000Z</published>
    <updated>2022-07-31T11:43:24.894Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>在开发小程序的时候遇到自定义分享按钮分享卡片到好友的需求，由于小程序的分享只有在页面 js 中定义了 onShareAppMessage(Object)方法才会出现右上角的分享按钮,所以需要在页面中自定义分享方法。具体见下：</p></blockquote><h6 id="object-参数"><a href="#object-参数" class="headerlink" title="object 参数"></a>object 参数</h6><p><img src="https://img-blog.csdnimg.cn/20200403173141911.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1ZfQVlBX1Y=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><h6 id="onShareAppMessage-Object-事件需要返回一个-Object-对象对象里面包含要分享的标题，转发的路径，以及自定义图片的路径。完成了这一系列操作就可以愉快的去分享微信小程序的页面了。"><a href="#onShareAppMessage-Object-事件需要返回一个-Object-对象对象里面包含要分享的标题，转发的路径，以及自定义图片的路径。完成了这一系列操作就可以愉快的去分享微信小程序的页面了。" class="headerlink" title="onShareAppMessage(Object)事件需要返回一个 Object 对象对象里面包含要分享的标题，转发的路径，以及自定义图片的路径。完成了这一系列操作就可以愉快的去分享微信小程序的页面了。"></a>onShareAppMessage(Object)事件需要返回一个 Object 对象对象里面包含要分享的标题，转发的路径，以及自定义图片的路径。完成了这一系列操作就可以愉快的去分享微信小程序的页面了。</h6><p><img src="https://img-blog.csdnimg.cn/20200403173002500.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1ZfQVlBX1Y=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在页面中使用</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Taro</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@tarojs/taro&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">View</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@tarojs/components&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">onShareAppMessage</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;自定义标题&quot;</span>,</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&quot;/page/user?id=123&quot;</span>, <span class="comment">// 自定义的分享路径，点击分享的卡片之后会跳转这里定义的路由</span></span><br><span class="line">      <span class="attr">imageUrl</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 图片路径</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">View</span>&gt;</span>微信分享<span class="tag">&lt;/<span class="name">View</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> index;</span><br></pre></td></tr></table></figure><blockquote><p>自定义分享按钮事件的实现。有时候，在大多数的业务场景下我们需要在页面中点击某个按钮触发分享的事件，此时需要监听用户点击页面内转发按钮（Button 组件 openType=’share’）就会自动触发 onShareAppMessage 方法。如果需要在 button 中携带信息，需要自定义 button 属性，通过 res.target.dataset 获取。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在页面中使用</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Taro</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@tarojs/taro&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">View</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@tarojs/components&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">onShareAppMessage</span>(<span class="params">res</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">from</span> === <span class="string">&quot;button&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; share = &#123;&#125; &#125; = res.<span class="property">target</span>.<span class="property">dataset</span>;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">`自定义分享按钮<span class="subst">$&#123;share.title&#125;</span>`</span>,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">`/pages/bill/index`</span>,</span><br><span class="line">        <span class="attr">imageUrl</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;右上角分享事件&quot;</span>,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">`/pages/bill/index`</span>,</span><br><span class="line">        <span class="attr">imageUrl</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Button</span> <span class="attr">open-type</span>=<span class="string">&quot;share&quot;</span> <span class="attr">data-share</span>=<span class="string">&#123;data&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          点击分享</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> index;</span><br></pre></td></tr></table></figure><blockquote><p>需要注意的是，onShareAppMessage 不支持异步调用，如果有需求是先请求接口的数据再分享会因为拿不到数据导致分享信息不正确的错误。</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;在开发小程序的时候遇到自定义分享按钮分享卡片到好友的需求，由于小程序的分享只有在页面 js 中定义了 onShareAppMessage(Object)方法才会出现右上角的分享按钮,所以需要在页面中自定义分享方法。具体见下：&lt;/p&gt;
&lt;/block</summary>
      
    
    
    
    <category term="taro" scheme="https://ovyvo.github.io/yanblog.github.io/categories/taro/"/>
    
    
    <category term="小程序" scheme="https://ovyvo.github.io/yanblog.github.io/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>vue 使用高德地图 Api 获取当前经纬度信息</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2020/04/02/blog1/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2020/04/02/blog1/</id>
    <published>2020-04-02T00:00:00.000Z</published>
    <updated>2022-07-31T11:43:24.894Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>在 utils 里面新建 getLocation.js 封装获取经纬度的公用方法(优化加载速度动态 cdn 引入高德地图) 由于高德 Api 方法获取当前经纬度比较慢，如果需求是在获取到当前经纬度数据之后请求一些数据，需要搭配 promise 使用保证获取到经纬度信息。具体见下面代码</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">loadSDK</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">AMap</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">    script.<span class="property">src</span> = <span class="string">&quot;http://webapi.amap.com/maps?v=1.4.6&amp;key=*****************&quot;</span>; <span class="comment">//***为申请的高德key</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">appendChild</span>(script);</span><br><span class="line">    script.<span class="property">onload</span> = resolve;</span><br><span class="line">    script.<span class="property">onerror</span> = reject;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">loadSDK</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// eslint-disable-next-line no-undef</span></span><br><span class="line">    <span class="title class_">AMap</span>.<span class="title function_">plugin</span>(<span class="string">&quot;AMap.Geolocation&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// eslint-disable-next-line no-undef</span></span><br><span class="line">      <span class="keyword">const</span> geolocation = <span class="keyword">new</span> <span class="title class_">AMap</span>.<span class="title class_">Geolocation</span>(&#123; <span class="attr">enableHighAccuracy</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">      geolocation.<span class="title function_">getCurrentPosition</span>(<span class="function">(<span class="params">status, result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> res =</span><br><span class="line">          status === <span class="string">&quot;complete&quot;</span></span><br><span class="line">            ? result.<span class="property">position</span></span><br><span class="line">            : &#123; <span class="attr">lat</span>: <span class="number">39.909187</span>, <span class="attr">lng</span>: <span class="number">116.397451</span> &#125;; <span class="comment">//默认北京 116.397451、39.909187</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;定位结果&quot;</span>, res);</span><br><span class="line">        <span class="title function_">resolve</span>(res);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>在 vue 页面中的使用（这里假设需求是请求离我最近店铺信息列表）</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main-container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list-item&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;(item,index) in list&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;index&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">//you can do something</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Api</span> <span class="keyword">from</span> <span class="string">&#x27;@/api/xxx.js&#x27;</span> <span class="comment">//引入请求接口的Api</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> getLocation <span class="keyword">from</span> <span class="string">&#x27;@/utils/getLocation&#x27;</span> <span class="comment">//引入getLocation方法</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">params</span>: &#123;&#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">list</span>: []</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">this</span>.<span class="title function_">fetchList</span>()</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">async</span> <span class="title function_">getPosition</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">const</span> &#123; lng, lat &#125; = <span class="keyword">await</span> <span class="title function_">getLocation</span>()</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="variable language_">this</span>.<span class="property">params</span> = &#123; lng, lat &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">async</span> <span class="title function_">fetchList</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">getPosition</span>()</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">const</span> &#123; list &#125; = <span class="keyword">await</span> <span class="title class_">Api</span>.<span class="title function_">fetchList</span>(<span class="variable language_">this</span>.<span class="property">params</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="variable language_">this</span>.<span class="property">list</span> = list</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">&#x27;less&#x27;</span> <span class="attr">scoped</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>注意如果在 index.html 中引入高德地图在全局使用 AMap 构造函数需要在 vue.config.js 添加如下配置,否则会报‘AMap is not defined’错误</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">configureWebpack</span>: &#123;</span><br><span class="line">    <span class="attr">externals</span>: &#123;</span><br><span class="line">      <span class="title class_">AMap</span>: <span class="string">&quot;AMap&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>在页面中使用（举个 🌰，代码未测试）</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">AMap</span> <span class="keyword">from</span> <span class="string">&#x27;AMap&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>&#123;</span><br><span class="line">  <span class="attr">methods</span>:&#123;</span><br><span class="line">    <span class="title function_">fn</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="title class_">AMap</span>.<span class="title function_">plugin</span>(<span class="string">&#x27;AMap.Geolocation&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> geolocation = <span class="keyword">new</span> <span class="title class_">AMap</span>.<span class="title class_">Geolocation</span>(&#123; <span class="attr">enableHighAccuracy</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">      geolocation.<span class="title function_">getCurrentPosition</span>(<span class="function">(<span class="params">status, result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> res =</span><br><span class="line">          status === <span class="string">&#x27;complete&#x27;</span></span><br><span class="line">            ? result.<span class="property">position</span></span><br><span class="line">            : &#123; <span class="attr">lat</span>: <span class="number">39.909187</span>, <span class="attr">lng</span>: <span class="number">116.397451</span> &#125; <span class="comment">//默认北京 116.397451、39.909187</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;定位结果&#x27;</span>, res)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;在 utils 里面新建 getLocation.js 封装获取经纬度的公用方法(优化加载速度动态 cdn 引入高德地图) 由于高德 Api 方法获取当前经纬度比较慢，如果需求是在获取到当前经纬度数据之后请求一些数据，需要搭配 promise 使用</summary>
      
    
    
    
    <category term="vue" scheme="https://ovyvo.github.io/yanblog.github.io/categories/vue/"/>
    
    
    <category term="工具" scheme="https://ovyvo.github.io/yanblog.github.io/tags/%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
</feed>
