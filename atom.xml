<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Yan&#39;s Blog</title>
  
  
  <link href="https://ovyvo.github.io/yanblog.github.io/atom.xml" rel="self"/>
  
  <link href="https://ovyvo.github.io/yanblog.github.io/"/>
  <updated>2022-07-31T11:56:48.542Z</updated>
  <id>https://ovyvo.github.io/yanblog.github.io/</id>
  
  <author>
    <name>OVYVO</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>H5在IOS微信webview中无法校验视频时长问题</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2022/07/31/blog5/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2022/07/31/blog5/</id>
    <published>2022-07-30T16:00:00.000Z</published>
    <updated>2022-07-31T11:56:48.542Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>因业务需求需要一个图片视频文件上传功能，需支持主流浏览器及微信钉钉内置浏览器，遂考虑用一个简单的H5页面做上传客户端。视频上传因为要控制视频长度，在其他浏览器中都校验通过，但是在微信中却出了问题</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">beforeRead</span> = (<span class="params">file</span>)=&gt; &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(props.<span class="property">type</span> == <span class="string">&#x27;video&#x27;</span>)&#123;</span><br><span class="line">          <span class="keyword">let</span> url = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(file)</span><br><span class="line">          <span class="keyword">let</span> audioElement = <span class="keyword">new</span> <span class="title class_">Audio</span>(url)</span><br><span class="line">          audioElement.<span class="title function_">addEventListener</span>(<span class="string">&quot;loadedmetadata&quot;</span>, <span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">let</span> audioDuration = audioElement.<span class="property">duration</span>;</span><br><span class="line">            <span class="keyword">if</span>(audioDuration&gt;<span class="number">60</span>)&#123;</span><br><span class="line">              <span class="title class_">Toast</span>(<span class="string">`仅支持上传1分钟时长以内视频`</span>)</span><br><span class="line">              <span class="title function_">reject</span>()</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="title function_">resolve</span>(file)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (![<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>].<span class="title function_">includes</span>(file.<span class="property">type</span>)) &#123;</span><br><span class="line">            <span class="title class_">Toast</span>(<span class="string">&#x27;所选文件格式不支持&#x27;</span>);</span><br><span class="line">            <span class="title function_">reject</span>()</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="title function_">resolve</span>(file)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>问题原因：IOS微信浏览器需要播放视频才能通过监听loadedmetadata事件获取视频长度，以下是解决办法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">beforeRead</span> = (<span class="params">file</span>)=&gt; &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(props.<span class="property">type</span> == <span class="string">&#x27;video&#x27;</span>)&#123;</span><br><span class="line">          <span class="keyword">let</span> url = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(file)</span><br><span class="line">          <span class="keyword">let</span> audioElement = <span class="keyword">new</span> <span class="title class_">Audio</span>(url)</span><br><span class="line">          audioElement.<span class="property">muted</span> = <span class="literal">true</span></span><br><span class="line">          audioElement.<span class="title function_">play</span>().<span class="title function_">then</span>(<span class="function">()=&gt;</span>audioElement.<span class="title function_">pause</span>())</span><br><span class="line">          audioElement.<span class="title function_">addEventListener</span>(<span class="string">&quot;loadedmetadata&quot;</span>, <span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">let</span> audioDuration = audioElement.<span class="property">duration</span>;</span><br><span class="line">            <span class="keyword">if</span>(audioDuration&gt;<span class="number">60</span>)&#123;</span><br><span class="line">              audioElement.<span class="property">muted</span> = <span class="literal">false</span></span><br><span class="line">              <span class="title class_">Toast</span>(<span class="string">`仅支持上传1分钟时长以内视频`</span>)</span><br><span class="line">              <span class="title function_">reject</span>()</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              audioElement.<span class="property">muted</span> = <span class="literal">false</span></span><br><span class="line">              <span class="title function_">resolve</span>(file)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (![<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>].<span class="title function_">includes</span>(file.<span class="property">type</span>)) &#123;</span><br><span class="line">            <span class="title class_">Toast</span>(<span class="string">&#x27;所选文件格式不支持&#x27;</span>);</span><br><span class="line">            <span class="title function_">reject</span>()</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="title function_">resolve</span>(file)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>H5页面vue3.0+vant，参见upload组件不再赘述！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;因业务需求需要一个图片视频文件上传功能，需支持主流浏览器及微信钉钉内置浏览器，遂考虑用一个简单的H5页面做上传客户端。视频上传因为要控制视频长度，在其他浏览器中都校验通过，但是在微信中却出了问题&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure </summary>
      
    
    
    
    <category term="vue" scheme="https://ovyvo.github.io/yanblog.github.io/categories/vue/"/>
    
    
    <category term="vue-3" scheme="https://ovyvo.github.io/yanblog.github.io/tags/vue-3/"/>
    
  </entry>
  
  <entry>
    <title>Taro小程序添加Echarts代码包过大解决办法</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2021/10/19/blog4/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2021/10/19/blog4/</id>
    <published>2021-10-19T00:00:00.000Z</published>
    <updated>2022-07-31T11:43:24.895Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>上回书说到如何在Taro小程序中引入Echarts图表。如果小程序主包代码体量不多可以直接使用，但是如果小程序代码体量大，稍不留神就会导致主包代码超过2M，无法预览也无法真机调试。本文着重介绍一下Taro引入Echarts分包操作以及注意事项。</p></blockquote><h6 id="前文链接，完整流程可以自行查阅-taro小程序添加Echarts实践"><a href="#前文链接，完整流程可以自行查阅-taro小程序添加Echarts实践" class="headerlink" title="前文链接，完整流程可以自行查阅 taro小程序添加Echarts实践"></a>前文链接，完整流程可以自行查阅 <a href="https://blog.csdn.net/V_AYA_V/article/details/120828878">taro小程序添加Echarts实践</a></h6><h6 id="分包操作："><a href="#分包操作：" class="headerlink" title="分包操作："></a>分包操作：</h6><ol><li>将与echarts组件相关都移到分包中，结构目录如下<br><img src="https://img-blog.csdnimg.cn/e54a142d784945938153d51fd8769eed.png" alt="在这里插入图片描述"></li><li>配置app.config.js</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="attr">subpackages</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">root</span>: <span class="string">&quot;subpages&quot;</span>,</span><br><span class="line">      <span class="attr">pages</span>: [</span><br><span class="line">        <span class="string">&#x27;test/index&#x27;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ol start="3"><li>配置config/index<blockquote><p>导致包文件过大的“罪魁祸首”就是ec-canvas文件夹下的echarts.js文件。所以我们需要解决的问题是，分包使用Echarts组件不能将echarts.js打包到主包的common.js里面。Taro机制认为一个js文件被多个模块依赖会将该js抽离到common.js。虽然我们关于Echarts相关的文件都放在subpages里面，但是如果引用多次还是会抽离到主包common.js。所以我们需要使用splitChunks将Echarts部分单独打包，然后使用addChunkPages 往页面注入依赖。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/index.js</span></span><br><span class="line"><span class="attr">mini</span>: &#123;</span><br><span class="line">    <span class="attr">compile</span>: &#123;</span><br><span class="line">      <span class="attr">exclude</span>: [</span><br><span class="line">        <span class="comment">// 跳过编译</span></span><br><span class="line">        path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;src/subpages/components/ec-canvas/echarts.js&#x27;</span>)</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    addChunkPages (pages) &#123;</span><br><span class="line">      pages.<span class="title function_">set</span>(<span class="string">&#x27;subpages/test/index&#x27;</span>, [<span class="string">&#x27;subpages/common&#x27;</span>])</span><br><span class="line">    &#125;,</span><br><span class="line">    webpackChain (chain) &#123;</span><br><span class="line">      chain.<span class="title function_">merge</span>(&#123;</span><br><span class="line">        <span class="attr">optimization</span>: &#123;</span><br><span class="line">          <span class="attr">splitChunks</span>: &#123;</span><br><span class="line">            <span class="attr">cacheGroups</span>: &#123;</span><br><span class="line">              <span class="attr">subpackagesCommon</span>: &#123;</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&#x27;subpages/common&#x27;</span>,</span><br><span class="line">                <span class="attr">minChunks</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="attr">test</span>: <span class="function">(<span class="params"><span class="variable language_">module</span>,chunks</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">const</span> isNoOnlySubpackRequired = chunks.<span class="title function_">find</span>(<span class="function"><span class="params">chunk</span> =&gt;</span> !(<span class="regexp">/\bsubpages\b/</span>.<span class="title function_">test</span>(chunk.<span class="property">name</span>)))</span><br><span class="line">                  <span class="keyword">return</span> !isNoOnlySubpackRequired</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">priority</span>: <span class="number">200</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ol><p>至此可以看到打包效果：<br><img src="https://img-blog.csdnimg.cn/620ab1f3bf9b4e3cb4ec911ba06d41fe.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVl9BWUFfVg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><h6 id="页面引用"><a href="#页面引用" class="headerlink" title="页面引用"></a>页面引用</h6><p>参考前文页面使用。此时如果我们运行代码，可能会发现一个问题：<br><img src="https://img-blog.csdnimg.cn/90ee2801ff3d4c0b84bfa9fa359a0ce4.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVl9BWUFfVg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>注意这个错误！提示找不到ec-canvas组件。<br><img src="https://img-blog.csdnimg.cn/dd60c0daa96c497ebc5d3c0dcfe6e101.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVl9BWUFfVg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>注意编译后的组件ec-canvas.js因为之前抽离了echarts.js，现在已经无法引入，所以需要在编译后的文件中引入subpages里面的common.js。</p><ol><li>添加引入plugin(代码很简单，可以先学习一下官方文档<a href="https://taro-docs.jd.com/taro/docs/plugin#%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E6%8F%92%E4%BB%B6">如何编写一个插件</a>)</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* eslint-disable import/no-commonjs */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  解决chunk包没有引用资源的问题</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">default</span> = <span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">ctx, options</span>) =&gt;</span> &#123;</span><br><span class="line">  ctx.<span class="title function_">onBuildFinish</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> chunkRequireArray = options.<span class="property">chunkRequireArray</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">in</span> chunkRequireArray)&#123;</span><br><span class="line">      <span class="keyword">const</span> unitData = chunkRequireArray[i];</span><br><span class="line">      <span class="keyword">const</span> target = path.<span class="title function_">join</span>(ctx.<span class="property">paths</span>.<span class="property">outputPath</span>, unitData.<span class="property">fileDistPath</span>);</span><br><span class="line">      <span class="keyword">const</span> data = fs.<span class="title function_">readFileSync</span>(target, <span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">      fs.<span class="title function_">writeFileSync</span>(target, <span class="string">`<span class="subst">$&#123;unitData.prependContent&#125;</span>;<span class="subst">$&#123;data&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>配置config/index.js</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">plugins</span>: [</span><br><span class="line">    [</span><br><span class="line">      path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;plugin/chunkCacheRequirePlugin&#x27;</span>),</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">chunkRequireArray</span>:[ <span class="comment">//可配置多个目标引入文件</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">fileDistPath</span>: <span class="string">&#x27;subpages/components/ec-canvas/ec-canvas.js&#x27;</span>,</span><br><span class="line">            <span class="attr">prependContent</span>: <span class="string">&#x27;require(&quot;../../common&quot;);&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  ],</span><br></pre></td></tr></table></figure><p>重新编译就可以了：</p><p><img src="https://img-blog.csdnimg.cn/847970db1d2e464dad26045b1f0f5520.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVl9BWUFfVg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;上回书说到如何在Taro小程序中引入Echarts图表。如果小程序主包代码体量不多可以直接使用，但是如果小程序代码体量大，稍不留神就会导致主包代码超过2M，无法预览也无法真机调试。本文着重介绍一下Taro引入Echarts分包操作以及注意事项。&lt;/</summary>
      
    
    
    
    <category term="taro" scheme="https://ovyvo.github.io/yanblog.github.io/categories/taro/"/>
    
    
    <category term="小程序" scheme="https://ovyvo.github.io/yanblog.github.io/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>Taro小程序引入Echarts教程</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2021/10/18/blog3/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2021/10/18/blog3/</id>
    <published>2021-10-18T00:00:00.000Z</published>
    <updated>2022-07-31T11:43:24.895Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>小程序需要添加简单的数据统计功能。因为对Echats比较熟悉，所以想将Echats引入到项目中，有几点注意事项，记录一下。</p></blockquote><blockquote><p>taro版本：3.3.2（注意一下版本信息）,官方物料仓库里面的Echarts大多不兼容最新版本taro框架，但是实现的思路都是一样的。大致说一下：</p></blockquote><h5 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h5><ol><li><p>下载Echarts官方的小程序插件echarts-for-weixin <a href="https://github.com/ecomfe/echarts-for-weixin">传送门</a><br><img src="https://img-blog.csdnimg.cn/c8b4e2c4f67c43dd88457ada54a57fc5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVl9BWUFfVg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p></li><li><p>将项目中的ec-canvas文件夹复制保存</p></li><li><p>去Echarts官网定制图表(不建议全部下载，文件太大，小程序体积大需要分包) <a href="https://echarts.apache.org/zh/builder.html">传送门</a></p></li><li><p>压缩echarts.js文件(压缩方法可以自行找线上压缩网站或自行压缩，方法附后文）</p></li><li><p>替换ec-canvas文件中的echarts.js文件<br><img src="https://img-blog.csdnimg.cn/375e575d3d6542d0915643b9ac1e9cda.png" alt="在这里插入图片描述"></p><h5 id="本地压缩方法"><a href="#本地压缩方法" class="headerlink" title="本地压缩方法"></a>本地压缩方法</h5></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install uglify-js -g</span><br><span class="line">uglifyjs echarts.<span class="property">js</span> -m -o echarts.<span class="property">min</span>.<span class="property">js</span> <span class="comment">//注意：替换ec-canvas里面的文件时将echarts.min.js换回来</span></span><br></pre></td></tr></table></figure><h5 id="小程序封装图表组件-以柱状图为例"><a href="#小程序封装图表组件-以柱状图为例" class="headerlink" title="小程序封装图表组件(以柱状图为例)"></a>小程序封装图表组件(以柱状图为例)</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 柱状图</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">View</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@tarojs/components&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getCurrentInstance &#125; <span class="keyword">from</span> <span class="string">&quot;@tarojs/taro&quot;</span> <span class="comment">//Taro3.x需要使用getCurrentInstance 获取页面DOM</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./index.scss&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setChartData</span>(<span class="params">chart</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> defautOption = &#123;</span><br><span class="line">    <span class="attr">xAxis</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;category&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: [<span class="string">&quot;Mon&quot;</span>, <span class="string">&quot;Tue&quot;</span>, <span class="string">&quot;Wed&quot;</span>, <span class="string">&quot;Thu&quot;</span>, <span class="string">&quot;Fri&quot;</span>, <span class="string">&quot;Sat&quot;</span>, <span class="string">&quot;Sun&quot;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">yAxis</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;value&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">series</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">data</span>: [<span class="number">120</span>, <span class="number">200</span>, <span class="number">150</span>, <span class="number">80</span>, <span class="number">70</span>, <span class="number">110</span>, <span class="number">130</span>],</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">        <span class="attr">showBackground</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">backgroundStyle</span>: &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="string">&quot;rgba(220, 220, 220, 0.8)&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;;</span><br><span class="line">  chart.<span class="title function_">setOption</span>(defautOption);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">BarChart</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">      <span class="attr">ec</span>: &#123;</span><br><span class="line">        <span class="attr">lazyLoad</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">refresh</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="title function_">getCurrentInstance</span>().<span class="property">page</span>.<span class="title function_">selectComponent</span>(<span class="string">&#x27;#mychart-area&#x27;</span>).<span class="title function_">init</span>(<span class="function">(<span class="params">canvas, width, height</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> chart = echarts.<span class="title function_">init</span>(canvas, <span class="literal">null</span>, &#123;</span><br><span class="line">        <span class="attr">width</span>: width,</span><br><span class="line">        <span class="attr">height</span>: height</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="title function_">setChartData</span>(chart, data);</span><br><span class="line">      <span class="keyword">return</span> chart;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;bar-chart&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ec-canvas</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">id</span>=<span class="string">&#x27;mychart-area&#x27;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">canvasId</span>=<span class="string">&#x27;mychart-area&#x27;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">ec</span>=<span class="string">&#123;this.state.ec&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="页面使用"><a href="#页面使用" class="headerlink" title="页面使用"></a>页面使用</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">View</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@tarojs/components&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">BarChart</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/barChart&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./index.scss&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (props) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">barChart</span> = <span class="title class_">React</span>.<span class="title function_">createRef</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillMount () &#123; &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount () &#123;</span><br><span class="line">    <span class="comment">// 延迟调用，确保 ec-canvas 节点已存在</span></span><br><span class="line">     <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">barChart</span>.<span class="property">current</span>.<span class="title function_">refresh</span>()</span><br><span class="line">     &#125;, <span class="number">100</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillUnmount () &#123; &#125;</span><br><span class="line"></span><br><span class="line">  componentDidShow () &#123; &#125;</span><br><span class="line"></span><br><span class="line">  componentDidHide () &#123; &#125;</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;selfstudy-container&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">BarChart</span> <span class="attr">ref</span>=<span class="string">&#123;this.barChart&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>——————————————————至此图表引入已完成90%————————————————————-<br>直接页面使用的话会报两个错误：</p><ol><li>echarts is not defined。（没有拿到ec-canvas页面实例）<br><img src="https://img-blog.csdnimg.cn/c1a7c829effb4f3c9c1c49e8c6604460.png" alt="在这里插入图片描述"></li></ol><p><strong>解决方法：在 app 或页面配置文件中配置 usingComponents 属性。</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">usingComponents</span>: &#123;</span><br><span class="line">    <span class="comment">// 定义需要引入的第三方组件</span></span><br><span class="line">    <span class="comment">// 1. key 值指定第三方组件名字，以小写开头</span></span><br><span class="line">    <span class="comment">// 2. value 值指定第三方组件 js 文件的相对路径</span></span><br><span class="line">    <span class="string">&#x27;ec-canvas&#x27;</span>: <span class="string">&#x27;../../components/ec-canvas/ec-canvas&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意：Taro3 的组件是没有配置文件的，因此 usingComponents 必须配置在“页面”的配置文件中。<br>2.  t.addEventListener is not a function<br> <img src="https://img-blog.csdnimg.cn/bafdf484508b477ba134037598e2654e.png" alt="在这里插入图片描述"><br><strong>解决方法：在 ec-canvas文件夹下面的wx-canvas.js文件添加代码：</strong></p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">WxCanvas</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">ctx, canvasId, isNew, canvasNode</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span> = ctx;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvasId</span> = canvasId;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chart</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isNew</span> = isNew</span><br><span class="line">    <span class="keyword">if</span> (isNew) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">canvasNode</span> = canvasNode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_initStyle</span>(ctx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this._initCanvas(zrender, ctx);</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_initEvent</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 新增空函数，修复调用 echarts.init 时报错</span></span><br><span class="line">  addEventListener () &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getContext</span>(<span class="params">contextType</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (contextType === <span class="string">&#x27;2d&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;小程序需要添加简单的数据统计功能。因为对Echats比较熟悉，所以想将Echats引入到项目中，有几点注意事项，记录一下。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;taro版本：3.3.2（注意一下版本信息）,官方物料仓</summary>
      
    
    
    
    <category term="taro" scheme="https://ovyvo.github.io/yanblog.github.io/categories/taro/"/>
    
    
    <category term="小程序" scheme="https://ovyvo.github.io/yanblog.github.io/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>Taro小程序分享</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2020/04/03/blog2/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2020/04/03/blog2/</id>
    <published>2020-04-03T00:00:00.000Z</published>
    <updated>2022-07-31T11:43:24.894Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>在开发小程序的时候遇到自定义分享按钮分享卡片到好友的需求，由于小程序的分享只有在页面 js 中定义了 onShareAppMessage(Object)方法才会出现右上角的分享按钮,所以需要在页面中自定义分享方法。具体见下：</p></blockquote><h6 id="object-参数"><a href="#object-参数" class="headerlink" title="object 参数"></a>object 参数</h6><p><img src="https://img-blog.csdnimg.cn/20200403173141911.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1ZfQVlBX1Y=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><h6 id="onShareAppMessage-Object-事件需要返回一个-Object-对象对象里面包含要分享的标题，转发的路径，以及自定义图片的路径。完成了这一系列操作就可以愉快的去分享微信小程序的页面了。"><a href="#onShareAppMessage-Object-事件需要返回一个-Object-对象对象里面包含要分享的标题，转发的路径，以及自定义图片的路径。完成了这一系列操作就可以愉快的去分享微信小程序的页面了。" class="headerlink" title="onShareAppMessage(Object)事件需要返回一个 Object 对象对象里面包含要分享的标题，转发的路径，以及自定义图片的路径。完成了这一系列操作就可以愉快的去分享微信小程序的页面了。"></a>onShareAppMessage(Object)事件需要返回一个 Object 对象对象里面包含要分享的标题，转发的路径，以及自定义图片的路径。完成了这一系列操作就可以愉快的去分享微信小程序的页面了。</h6><p><img src="https://img-blog.csdnimg.cn/20200403173002500.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1ZfQVlBX1Y=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在页面中使用</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Taro</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@tarojs/taro&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">View</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@tarojs/components&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">onShareAppMessage</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;自定义标题&quot;</span>,</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&quot;/page/user?id=123&quot;</span>, <span class="comment">// 自定义的分享路径，点击分享的卡片之后会跳转这里定义的路由</span></span><br><span class="line">      <span class="attr">imageUrl</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 图片路径</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">View</span>&gt;</span>微信分享<span class="tag">&lt;/<span class="name">View</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> index;</span><br></pre></td></tr></table></figure><blockquote><p>自定义分享按钮事件的实现。有时候，在大多数的业务场景下我们需要在页面中点击某个按钮触发分享的事件，此时需要监听用户点击页面内转发按钮（Button 组件 openType=’share’）就会自动触发 onShareAppMessage 方法。如果需要在 button 中携带信息，需要自定义 button 属性，通过 res.target.dataset 获取。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在页面中使用</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Taro</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@tarojs/taro&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">View</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@tarojs/components&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">onShareAppMessage</span>(<span class="params">res</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">from</span> === <span class="string">&quot;button&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; share = &#123;&#125; &#125; = res.<span class="property">target</span>.<span class="property">dataset</span>;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">`自定义分享按钮<span class="subst">$&#123;share.title&#125;</span>`</span>,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">`/pages/bill/index`</span>,</span><br><span class="line">        <span class="attr">imageUrl</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;右上角分享事件&quot;</span>,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">`/pages/bill/index`</span>,</span><br><span class="line">        <span class="attr">imageUrl</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Button</span> <span class="attr">open-type</span>=<span class="string">&quot;share&quot;</span> <span class="attr">data-share</span>=<span class="string">&#123;data&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          点击分享</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> index;</span><br></pre></td></tr></table></figure><blockquote><p>需要注意的是，onShareAppMessage 不支持异步调用，如果有需求是先请求接口的数据再分享会因为拿不到数据导致分享信息不正确的错误。</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;在开发小程序的时候遇到自定义分享按钮分享卡片到好友的需求，由于小程序的分享只有在页面 js 中定义了 onShareAppMessage(Object)方法才会出现右上角的分享按钮,所以需要在页面中自定义分享方法。具体见下：&lt;/p&gt;
&lt;/block</summary>
      
    
    
    
    <category term="taro" scheme="https://ovyvo.github.io/yanblog.github.io/categories/taro/"/>
    
    
    <category term="小程序" scheme="https://ovyvo.github.io/yanblog.github.io/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>vue 使用高德地图 Api 获取当前经纬度信息</title>
    <link href="https://ovyvo.github.io/yanblog.github.io/2020/04/02/blog1/"/>
    <id>https://ovyvo.github.io/yanblog.github.io/2020/04/02/blog1/</id>
    <published>2020-04-02T00:00:00.000Z</published>
    <updated>2022-07-31T11:43:24.894Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>在 utils 里面新建 getLocation.js 封装获取经纬度的公用方法(优化加载速度动态 cdn 引入高德地图) 由于高德 Api 方法获取当前经纬度比较慢，如果需求是在获取到当前经纬度数据之后请求一些数据，需要搭配 promise 使用保证获取到经纬度信息。具体见下面代码</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">loadSDK</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">AMap</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">    script.<span class="property">src</span> = <span class="string">&quot;http://webapi.amap.com/maps?v=1.4.6&amp;key=*****************&quot;</span>; <span class="comment">//***为申请的高德key</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">appendChild</span>(script);</span><br><span class="line">    script.<span class="property">onload</span> = resolve;</span><br><span class="line">    script.<span class="property">onerror</span> = reject;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">loadSDK</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// eslint-disable-next-line no-undef</span></span><br><span class="line">    <span class="title class_">AMap</span>.<span class="title function_">plugin</span>(<span class="string">&quot;AMap.Geolocation&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// eslint-disable-next-line no-undef</span></span><br><span class="line">      <span class="keyword">const</span> geolocation = <span class="keyword">new</span> <span class="title class_">AMap</span>.<span class="title class_">Geolocation</span>(&#123; <span class="attr">enableHighAccuracy</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">      geolocation.<span class="title function_">getCurrentPosition</span>(<span class="function">(<span class="params">status, result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> res =</span><br><span class="line">          status === <span class="string">&quot;complete&quot;</span></span><br><span class="line">            ? result.<span class="property">position</span></span><br><span class="line">            : &#123; <span class="attr">lat</span>: <span class="number">39.909187</span>, <span class="attr">lng</span>: <span class="number">116.397451</span> &#125;; <span class="comment">//默认北京 116.397451、39.909187</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;定位结果&quot;</span>, res);</span><br><span class="line">        <span class="title function_">resolve</span>(res);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>在 vue 页面中的使用（这里假设需求是请求离我最近店铺信息列表）</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main-container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;list-item&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;(item,index) in list&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;index&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">//you can do something</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Api</span> <span class="keyword">from</span> <span class="string">&#x27;@/api/xxx.js&#x27;</span> <span class="comment">//引入请求接口的Api</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> getLocation <span class="keyword">from</span> <span class="string">&#x27;@/utils/getLocation&#x27;</span> <span class="comment">//引入getLocation方法</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">params</span>: &#123;&#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">list</span>: []</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">this</span>.<span class="title function_">fetchList</span>()</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">async</span> <span class="title function_">getPosition</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">const</span> &#123; lng, lat &#125; = <span class="keyword">await</span> <span class="title function_">getLocation</span>()</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="variable language_">this</span>.<span class="property">params</span> = &#123; lng, lat &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">async</span> <span class="title function_">fetchList</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">getPosition</span>()</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">const</span> &#123; list &#125; = <span class="keyword">await</span> <span class="title class_">Api</span>.<span class="title function_">fetchList</span>(<span class="variable language_">this</span>.<span class="property">params</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="variable language_">this</span>.<span class="property">list</span> = list</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">&#x27;less&#x27;</span> <span class="attr">scoped</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>注意如果在 index.html 中引入高德地图在全局使用 AMap 构造函数需要在 vue.config.js 添加如下配置,否则会报‘AMap is not defined’错误</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">configureWebpack</span>: &#123;</span><br><span class="line">    <span class="attr">externals</span>: &#123;</span><br><span class="line">      <span class="title class_">AMap</span>: <span class="string">&quot;AMap&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>在页面中使用（举个 🌰，代码未测试）</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">AMap</span> <span class="keyword">from</span> <span class="string">&#x27;AMap&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>&#123;</span><br><span class="line">  <span class="attr">methods</span>:&#123;</span><br><span class="line">    <span class="title function_">fn</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="title class_">AMap</span>.<span class="title function_">plugin</span>(<span class="string">&#x27;AMap.Geolocation&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> geolocation = <span class="keyword">new</span> <span class="title class_">AMap</span>.<span class="title class_">Geolocation</span>(&#123; <span class="attr">enableHighAccuracy</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">      geolocation.<span class="title function_">getCurrentPosition</span>(<span class="function">(<span class="params">status, result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> res =</span><br><span class="line">          status === <span class="string">&#x27;complete&#x27;</span></span><br><span class="line">            ? result.<span class="property">position</span></span><br><span class="line">            : &#123; <span class="attr">lat</span>: <span class="number">39.909187</span>, <span class="attr">lng</span>: <span class="number">116.397451</span> &#125; <span class="comment">//默认北京 116.397451、39.909187</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;定位结果&#x27;</span>, res)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;在 utils 里面新建 getLocation.js 封装获取经纬度的公用方法(优化加载速度动态 cdn 引入高德地图) 由于高德 Api 方法获取当前经纬度比较慢，如果需求是在获取到当前经纬度数据之后请求一些数据，需要搭配 promise 使用</summary>
      
    
    
    
    <category term="vue" scheme="https://ovyvo.github.io/yanblog.github.io/categories/vue/"/>
    
    
    <category term="工具" scheme="https://ovyvo.github.io/yanblog.github.io/tags/%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
</feed>
